# PGP

**=== THIS IS PRE-ALPHA SOFTWARE - USE AT YOUR OWN RISK ====**

The PGP application allows multiple parties to communicate through PGP
(Pretty Good Privacy) encryption in Privly. PGP keys are generated by
[OpenPGP.js](http://openpgpjs.org) and public keys are uploaded to a
Key Server. Identities are verified through the use of [Mozilla
Persona](https://persona.org). The primary focus is to provide user
friendly PGP encryption.

### Remote Resources
There are 3 remote resources involved in this application:

  *  **Directory Provider:** Provides a remote key-value store for public
     keys and their associated backed identity assertion.
  *  **Remote Verifier:** Authenticates the backed identity assertion
     associated with an email address and public key. Long term the
     intent is to run a verifier locally in the browser.
  *  **Content Server:** Provides a location for message storage and
     retrieval. Note that the content server only stores the ciphertext
     of messagesr, private keys are created locally, and private keys
     never leave the browser.

For more details on the protocol for this app, see the
[protocol](PROTOCOL.md) document.

### Current Status

Currently the app supports basic encryption/decryption of content posted and
retrieved from a content server. This is currently done with keys read from
local storage. Key management is currently being implemented.

Tests are written for OpenPGP.js in the Privly context that confirm correctness
of the encryption, key generation, and signing and verification of encrypted
messages. Basic tests for the personapgp functions are outlined but not
implemented.

Note that the verifyPubKey function in pgp/js/personapgp.js is not currently
performing the actions that it should.  Currently, it just returns true instead
of performing any verification. This is because the generation of backed
identity assertions is not yet mature.  A good reminder as to why this software
is PRE-ALPHA status.

### Current TODO
- Security:
  - PGP Sign and verify messages (https://github.com/privly/privly-applications/issues/42)
  - Locally verify backed identity assertions by browserifying and
    including 'mozilla/browserid-local-verify'
  - Add support to OpenPGP.js for setting key expiration on creation (https://github.com/privly/privly-applications/issues/62)
  - Assess the OpenPGP.js source of entropy (https://github.com/privly/privly-applications/issues/65)
  - Extend persona bia expiration time

- Basic funcitonality:
  - Enable editing of content after creation

- UX:
  - Provide better user feedback when signing in with Persona
  - UI corrections (https://github.com/privly/privly-applications/issues/66)
  - Autocomplete form (https://github.com/privly/privly-applications/issues/68)
  - Rich Address book/contacts

- Best Practices:
  - Change HTTP request method (https://github.com/privly/privly-applications/issues/69)
  - Complete test coverage
  
- Documentation:
  - Update PROTOCOL to reflect current system, and things we do apart from
    Persona.
  - Create CONTRIBUTE document to get people up to speed.
  - Create diagram to visually represent the architecture of the app.



### Storage
Storage of keys and other data important to the Privly PGP application is
stored using a privly-wide storage shim. This is because no form of local
storage is supported across all browsers and platforms.  This means that the
storage back end that the application uses depends on which browser or platform
you are using. For more information see the
[source](../shared/javascripts/local_storage.js).

The PGP keys in local storage are of two types. Your own keypairs, and the
public keys of your contacts.

```
{
  my_keypairs: { email: [keypairs]    },
  my_contacts: { email: [public keys] }
}
```

In other words, local storage contains two key related entries, `my_contacts`
and `my_keypairs`.  Both entries have values that are a hash where emails are
keys with a corresponding value of an array of public keys or keypairs,
respectively. In the case of your keypairs, the key is naturally your own
email.

Additionally, the Privly PGP application stores the email address provided by
the user, and the URL of a directory provider.  The persona private key and the
payload to be uploaded to a directory provider are temporarily stored as well.


### Getting Started with Development

To get started developing the PGP app in chrome:

1.  Clone the repositories with ```git clone --recursive https://github.com/privly/privly-chrome.git```.
1.  run ```cd privly-chrome``` to switch into the privly-chrome folder.
1.  Change the branch in privly-chrome to expiremental-apps with
    ```git checkout expiremental-apps```.
1.  run ```cd privly-applications``` to switch into the privly-applications folder.
1.  Change the branch in privly-applications to expiremental-pgp with
    ```git checkout expiremental-pgp```.
1.  In chrome on the extensions page, check the 'Developer mode' box.
1.  Click load unpacked extension and load your privly-chrome folder.
